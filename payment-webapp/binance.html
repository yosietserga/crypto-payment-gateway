<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Binance Integration - Crypto Payment Gateway</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/apexcharts@3.40.0/dist/apexcharts.css">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/dashboard.css">
    <style>
        .balance-card {
            text-align: center;
            padding: 15px;
        }
        .balance-value {
            font-size: 24px;
            font-weight: bold;
        }
        .balance-label {
            font-size: 14px;
            color: #6c757d;
        }
        .badge-pending {
            background-color: #ffc107;
        }
        .badge-completed {
            background-color: #28a745;
        }
        .badge-failed {
            background-color: #dc3545;
        }
    </style>
</head>
<body class="dashboard-body">
    <div class="dashboard-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <!-- Replaced problematic image with Bootstrap icon -->
                <i class="bi bi-currency-exchange fs-3 text-primary sidebar-logo"></i>
                <h1 class="sidebar-title">Payment Gateway</h1>
                <button class="sidebar-toggle d-md-none" id="sidebar-toggle" aria-label="Toggle sidebar">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            
            <nav class="sidebar-nav">
                <ul class="sidebar-menu">
                    <li class="sidebar-menu-item">
                        <a href="dashboard.html" class="sidebar-menu-link">
                            <i class="bi bi-speedometer2"></i>
                            <span>Dashboard</span>
                        </a>
                    </li>
                    <li class="sidebar-menu-item">
                        <a href="payments.html" class="sidebar-menu-link">
                            <i class="bi bi-wallet2"></i>
                            <span>Payments</span>
                        </a>
                    </li>
                    <li class="sidebar-menu-item">
                        <a href="payouts.html" class="sidebar-menu-link">
                            <i class="bi bi-send"></i>
                            <span>Payouts</span>
                        </a>
                    </li>
                    <li class="sidebar-menu-item">
                        <a href="addresses.html" class="sidebar-menu-link">
                            <i class="bi bi-credit-card"></i>
                            <span>Addresses</span>
                        </a>
                    </li>
                    <li class="sidebar-menu-item active">
                        <a href="binance.html" class="sidebar-menu-link">
                            <i class="bi bi-currency-exchange"></i>
                            <span>Binance</span>
                        </a>
                    </li>
                    <li class="sidebar-menu-item">
                        <a href="webhooks.html" class="sidebar-menu-link">
                            <i class="bi bi-hdd-network"></i>
                            <span>Webhooks</span>
                        </a>
                    </li>
                    <li class="sidebar-menu-item">
                        <a href="api-keys.html" class="sidebar-menu-link">
                            <i class="bi bi-key"></i>
                            <span>API Keys</span>
                        </a>
                    </li>
                    <li class="sidebar-menu-divider"></li>
                    <li class="sidebar-menu-item">
                        <a href="settings.html" class="sidebar-menu-link">
                            <i class="bi bi-gear"></i>
                            <span>Settings</span>
                        </a>
                    </li>
                    <li class="sidebar-menu-item">
                        <a href="#" class="sidebar-menu-link" id="logout-link">
                            <i class="bi bi-box-arrow-right"></i>
                            <span>Logout</span>
                        </a>
                    </li>
                </ul>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="content-header">
                <button class="menu-toggle d-md-none" id="menu-toggle" aria-label="Toggle menu">
                    <i class="bi bi-list"></i>
                </button>
                <div class="header-actions">
                    <div class="dropdown">
                        <button class="btn btn-outline-light dropdown-toggle" id="create-btn" data-bs-toggle="dropdown" aria-expanded="false">
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="user-dropdown">
                            <li><a class="dropdown-item" href="profile.html"><i class="bi bi-person"></i> Profile</a></li>
                            <li><a class="dropdown-item" href="settings.html"><i class="bi bi-gear"></i> Settings</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" id="header-logout-link"><i class="bi bi-box-arrow-right"></i> Logout</a></li>
                        </ul>
                    </div>
                </div>
            </header>

            <div class="content-body">
                <div class="page-title-wrapper">
                    <h1 class="page-title">Binance Integration</h1>
                    <div class="page-actions">
                        <button type="button" class="btn btn-primary" id="refresh-btn">
                            <i class="bi bi-arrow-repeat"></i> Refresh
                        </button>
                        <button type="button" class="btn btn-success" id="configure-binance-btn" data-bs-toggle="modal" data-bs-target="#configure-api-modal">
                            <i class="bi bi-gear"></i> Configure API Keys
                        </button>
                    </div>
                </div>
                
                <!-- Connection Status -->
                <div class="alert" role="alert" id="connection-status">
                    <div class="d-flex align-items-center">
                        <div class="connection-status-indicator" id="connection-status-indicator"></div>
                        <div class="ms-2" id="connection-status-message">Checking connection...</div>
                    </div>
                </div>
                
                <!-- Binance Tabs Navigation -->
                <ul class="nav nav-tabs mb-4" id="binanceTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard" type="button" role="tab" aria-controls="dashboard" aria-selected="true">
                            <i class="bi bi-graph-up"></i> Dashboard
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="wallet-tab" data-bs-toggle="tab" data-bs-target="#wallet" type="button" role="tab" aria-controls="wallet" aria-selected="false">
                            <i class="bi bi-wallet2"></i> Wallet
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="payments-tab" data-bs-toggle="tab" data-bs-target="#payments" type="button" role="tab" aria-controls="payments" aria-selected="false">
                            <i class="bi bi-cash-coin"></i> Payments
                        </button>
                    </li>
                </ul>
                
                <!-- Tab Content -->
                <div class="tab-content" id="binanceTabsContent">
                    <!-- Dashboard Tab -->
                    <div class="tab-pane fade show active" id="dashboard" role="tabpanel" aria-labelledby="dashboard-tab">
                        <!-- Dashboard Overview -->
                        <div class="row g-3 mb-4">
                            <div class="col-md-4">
                                <div class="card h-100">
                                    <div class="card-body text-center">
                                        <h5 class="card-title">Total Balance</h5>
                                        <div class="mt-4 mb-2">
                                            <h2 class="mb-0" id="total-balance-value">Loading...</h2>
                                            <p class="text-muted">Estimated Value</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card h-100">
                                    <div class="card-body text-center">
                                        <h5 class="card-title">Active Coins</h5>
                                        <div class="mt-4 mb-2">
                                            <h2 class="mb-0" id="active-coins-count">Loading...</h2>
                                            <p class="text-muted">Currencies with balance</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card h-100">
                                    <div class="card-body text-center">
                                        <h5 class="card-title">Last Transaction</h5>
                                        <div class="mt-4 mb-2">
                                            <h3 class="mb-0" id="last-transaction-time">Loading...</h3>
                                            <p class="text-muted" id="last-transaction-info">Waiting for data...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Wallet Balances Summary -->
                        <div class="row g-3 mb-4">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h5 class="card-title mb-0">Wallet Balances</h5>
                                <div class="spinner-border spinner-border-sm text-primary d-none" id="balances-loader" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="row g-3" id="wallet-balances">
                                    <div class="col-12">
                                        <p class="text-center text-muted my-5">Loading balances...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row g-3">
                    <!-- Transactions -->
                    <div class="col-lg-12">
                        <div class="card">
                            <div class="card-header">
                                <ul class="nav nav-tabs card-header-tabs" id="transactions-tabs" role="tablist">
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link active" id="all-tab" data-bs-toggle="tab" data-bs-target="#all-transactions" type="button" role="tab" aria-controls="all-transactions" aria-selected="true">
                                            All Transactions
                                        </button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="deposits-tab" data-bs-toggle="tab" data-bs-target="#deposits" type="button" role="tab" aria-controls="deposits" aria-selected="false">
                                            Deposits
                                        </button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="withdrawals-tab" data-bs-toggle="tab" data-bs-target="#withdrawals" type="button" role="tab" aria-controls="withdrawals" aria-selected="false">
                                            Withdrawals
                                        </button>
                                    </li>
                                </ul>
                            </div>
                            <div class="card-body">
                                <div class="tab-content" id="transactions-tabs-content">
                                    <!-- All Transactions Tab -->
                                    <div class="tab-pane fade show active" id="all-transactions" role="tabpanel" aria-labelledby="all-tab">
                                        <div class="table-responsive">
                                            <table class="table table-hover">
                                                <thead>
                                                    <tr>
                                                        <th>Transaction</th>
                                                        <th>Amount</th>
                                                        <th>Status</th>
                                                        <th>Actions</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="all-transactions-table-body">
                                                    <tr>
                                                        <td colspan="4" class="text-center">Loading transactions...</td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    
                                    <!-- Deposits Tab -->
                                    <div class="tab-pane fade" id="deposits" role="tabpanel" aria-labelledby="deposits-tab">
                                        <div class="table-responsive">
                                            <table class="table table-hover">
                                                <thead>
                                                    <tr>
                                                        <th>Deposit</th>
                                                        <th>Amount</th>
                                                        <th>Status</th>
                                                        <th>Actions</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="deposits-table-body">
                                                    <tr>
                                                        <td colspan="4" class="text-center">Loading deposits...</td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    
                                    <!-- Withdrawals Tab -->
                                    <div class="tab-pane fade" id="withdrawals" role="tabpanel" aria-labelledby="withdrawals-tab">
                                        <div class="table-responsive">
                                            <table class="table table-hover">
                                                <thead>
                                                    <tr>
                                                        <th>Withdrawal</th>
                                                        <th>Amount</th>
                                                        <th>Status</th>
                                                        <th>Actions</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="withdrawals-table-body">
                                                    <tr>
                                                        <td colspan="4" class="text-center">Loading withdrawals...</td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Configure API Keys Modal -->
    <div class="modal fade" id="configure-api-modal" tabindex="-1" aria-labelledby="configure-api-modal-label" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="configure-api-modal-label">Configure Binance API Keys</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="binance-api-form">
                        <div class="mb-3">
                            <label for="api-key" class="form-label">API Key</label>
                            <input type="text" class="form-control" id="api-key" placeholder="Enter your Binance API Key">
                        </div>
                        <div class="mb-3">
                            <label for="api-secret" class="form-label">API Secret</label>
                            <input type="password" class="form-control" id="api-secret" placeholder="Enter your Binance API Secret">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Network</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="network" id="network-bep20" value="BEP20" checked>
                                <label class="form-check-label" for="network-bep20">
                                    BEP20 (Binance Smart Chain)
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="network" id="network-erc20" value="ERC20">
                                <label class="form-check-label" for="network-erc20">
                                    ERC20 (Ethereum)
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="network" id="network-trc20" value="TRC20">
                                <label class="form-check-label" for="network-trc20">
                                    TRC20 (Tron)
                                </label>
                            </div>
                        </div>
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle me-2"></i> Make sure your API Key has the following permissions:
                            <ul class="mb-0 mt-2">
                                <li>Read-only access to account information</li>
                                <li>Enable reading of deposit and withdrawal history</li>
                                <li>Enable withdrawal capabilities (if needed)</li>
                            </ul>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="save-api-keys-btn">Save & Connect</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Transaction Details Modal -->
    <div class="modal fade" id="transaction-details-modal" tabindex="-1" aria-labelledby="transaction-details-modal-label" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="transaction-details-modal-label">Transaction Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="transaction-details-content">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-3">Loading transaction details...</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts@3.40.0/dist/apexcharts.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="js/app.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/payment-api.js"></script>
    <script src="js/binance-real.js"></script>
    <script src="js/binance-ui-real.js"></script>
    <script src="js/binance-methods-real.js"></script>
    <script>
        // Mobile menu toggle
        document.getElementById('menu-toggle').addEventListener('click', function() {
            document.getElementById('sidebar').classList.add('show');
        });
        
        document.getElementById('sidebar-toggle').addEventListener('click', function() {
            document.getElementById('sidebar').classList.remove('show');
        });

        // Initialize Binance Dashboard
        // Function to validate JWT token
        async function checkAndRefreshToken() {
            // TEMPORARY FIX: Always return true to bypass authentication for demo
            return true;
            
            // This code is commented out to prevent redirect loops
            /*
            // Get token from local storage
            const token = localStorage.getItem('auth_token');
            
            // If token exists, check if it's still valid
            if (token) {
                try {
                    // Simple check for token structure, replace with actual token validation
                    return true;
                } catch (error) {
                    console.error('Token validation error:', error);
                    // Redirect to login if token is invalid
                    window.location.href = 'login.html';
                    return false;
                }
            } else {
                // No token found, redirect to login
                window.location.href = 'login.html';
                return false;
            }
            */
        }
        
        document.addEventListener('DOMContentLoaded', async function() {
            // Check authentication
            await checkAndRefreshToken();
            
            // Note: BinanceDashboardUI is already initialized in binance-ui-real.js
            // Access the existing instance
            const binanceDashboard = window.binanceDashboard;
            
            // Handle API configuration form submission
            document.getElementById('save-api-keys-btn').addEventListener('click', async function() {
                // Get form data
                const apiKey = document.getElementById('api-key').value.trim();
                const apiSecret = document.getElementById('api-secret').value.trim();
                let network = 'BEP20'; // Default
                
                // Get selected network
                const networkRadios = document.querySelectorAll('input[name="network"]');
                for (const radio of networkRadios) {
                    if (radio.checked) {
                        network = radio.value;
                        break;
                    }
                }
                
                if (!apiKey || !apiSecret) {
                    alert('Please enter both API Key and API Secret');
                    return;
                }
                
                try {
                    // Save credentials and test connection
                    await binanceDashboard.saveApiKeys(apiKey, apiSecret, network);
                    
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('configure-api-modal'));
                    modal.hide();
                    
                    // Refresh data
                    binanceDashboard.refreshData();
                } catch (error) {
                    alert(`Error saving API keys: ${error.message}`);
                }
            });
            
            // Handle refresh button
            document.getElementById('refresh-btn').addEventListener('click', function() {
                binanceDashboard.refreshData();
            });
            
            // Handle tab changes to load appropriate data
            const tabs = document.querySelectorAll('button[data-bs-toggle="tab"]');
            tabs.forEach(tab => {
                tab.addEventListener('shown.bs.tab', function(event) {
                    const targetId = event.target.getAttribute('data-bs-target').substring(1);
                    binanceDashboard.handleTabChange(targetId);
                });
            });
            
            // Initialize withdrawal form
            document.getElementById('withdrawal-form')?.addEventListener('submit', async function(event) {
                event.preventDefault();
                
                const currency = document.getElementById('withdrawal-currency').value;
                const network = document.getElementById('withdrawal-network').value;
                const address = document.getElementById('withdrawal-address').value.trim();
                const amount = parseFloat(document.getElementById('withdrawal-amount').value);
                
                if (!currency || !network || !address || isNaN(amount) || amount <= 0) {
                    alert('Please fill all withdrawal fields with valid values');
                    return;
                }
                
                try {
                    await binanceDashboard.createWithdrawal({
                        currency,
                        network,
                        address,
                        amount
                    });
                    
                    // Reset form
                    document.getElementById('withdrawal-form').reset();
                    
                    // Refresh data
                    binanceDashboard.refreshData();
                } catch (error) {
                    alert(`Error creating withdrawal: ${error.message}`);
                }
            });
            
            // Initialize payment request form
            document.getElementById('payment-request-form')?.addEventListener('submit', async function(event) {
                event.preventDefault();
                
                const currency = document.getElementById('payment-currency').value;
                const network = document.getElementById('payment-network').value;
                const amount = parseFloat(document.getElementById('payment-amount').value);
                const memo = document.getElementById('payment-memo').value.trim();
                
                if (!currency || !network || isNaN(amount) || amount <= 0) {
                    alert('Please fill all payment fields with valid values');
                    return;
                }
                
                try {
                    await binanceDashboard.createPaymentRequest({
                        currency,
                        network,
                        amount,
                        memo
                    });
                    
                    // Reset form
                    document.getElementById('payment-request-form').reset();
                    
                    // Refresh data
                    binanceDashboard.refreshData();
                } catch (error) {
                    alert(`Error creating payment request: ${error.message}`);
                }
            });
        });
        
        // Logout functionality
        function handleLogout(e) {
            e.preventDefault();
            // Use the auth.js logout function to ensure proper cleanup
            if (typeof window.logout === 'function') {
                window.logout();
            } else {
                localStorage.removeItem('jwt_token');
                localStorage.removeItem('user_data');
                window.location.href = 'login.html';
            }
        }
        
        document.getElementById('logout-link').addEventListener('click', handleLogout);
        document.getElementById('header-logout-link').addEventListener('click', handleLogout);
        
        // Set user info
        const userData = JSON.parse(localStorage.getItem('user_data') || '{}');
        if (userData.firstName && userData.lastName) {
            document.getElementById('user-name').textContent = `${userData.firstName} ${userData.lastName}`;
            document.getElementById('user-initials').textContent = `${userData.firstName.charAt(0)}${userData.lastName.charAt(0)}`;
        }
    </script>
</body>
</html>
