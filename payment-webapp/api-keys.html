<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Keys - Crypto Payment Gateway</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/dashboard.css">
</head>
<body class="dashboard-body">
    <div class="dashboard-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <img src="img/logo.svg" alt="Logo" class="sidebar-logo">
                <h1 class="sidebar-title">Payment Gateway</h1>
                <button class="sidebar-toggle d-md-none" id="sidebar-toggle" aria-label="Toggle sidebar">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            
            <nav class="sidebar-nav">
                <ul class="sidebar-menu">
                    <li class="sidebar-menu-item">
                        <a href="dashboard.html" class="sidebar-menu-link">
                            <i class="bi bi-speedometer2"></i>
                            <span>Dashboard</span>
                        </a>
                    </li>
                    <li class="sidebar-menu-item">
                        <a href="payments.html" class="sidebar-menu-link">
                            <i class="bi bi-wallet2"></i>
                            <span>Payments</span>
                        </a>
                    </li>
                    <li class="sidebar-menu-item">
                        <a href="payouts.html" class="sidebar-menu-link">
                            <i class="bi bi-send"></i>
                            <span>Payouts</span>
                        </a>
                    </li>
                    <li class="sidebar-menu-item">
                        <a href="addresses.html" class="sidebar-menu-link">
                            <i class="bi bi-credit-card"></i>
                            <span>Addresses</span>
                        </a>
                    </li>
                    <li class="sidebar-menu-item">
                        <a href="webhooks.html" class="sidebar-menu-link">
                            <i class="bi bi-hdd-network"></i>
                            <span>Webhooks</span>
                        </a>
                    </li>
                    <li class="sidebar-menu-item active">
                        <a href="api-keys.html" class="sidebar-menu-link">
                            <i class="bi bi-key"></i>
                            <span>API Keys</span>
                        </a>
                    </li>
                    <li class="sidebar-menu-divider"></li>
                    <li class="sidebar-menu-item">
                        <a href="settings.html" class="sidebar-menu-link">
                            <i class="bi bi-gear"></i>
                            <span>Settings</span>
                        </a>
                    </li>
                    <li class="sidebar-menu-item">
                        <a href="#" class="sidebar-menu-link" id="logout-link">
                            <i class="bi bi-box-arrow-right"></i>
                            <span>Logout</span>
                        </a>
                    </li>
                </ul>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="content-header">
                <button class="menu-toggle d-md-none" id="menu-toggle" aria-label="Toggle menu">
                    <i class="bi bi-list"></i>
                </button>
                
                <div class="header-actions">
                    <div class="dropdown me-3">
                        <button class="btn btn-sm btn-outline-primary dropdown-toggle" type="button" id="quickActionBtn" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-plus-lg"></i> Quick Actions
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="quickActionBtn">
                            <li><a class="dropdown-item" href="create-payment.html"><i class="bi bi-wallet2 me-2"></i>Create Payment</a></li>
                            <li><a class="dropdown-item" href="create-payout.html"><i class="bi bi-send me-2"></i>Create Payout</a></li>
                            <li><a class="dropdown-item" href="generate-address.html"><i class="bi bi-credit-card me-2"></i>Generate Address</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="api-docs.html"><i class="bi bi-code-slash me-2"></i>API Documentation</a></li>
                        </ul>
                    </div>
                    
                    <div class="dropdown">
                        <button class="user-dropdown" type="button" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            <div class="user-avatar">
                                <span id="user-initials">JD</span>
                            </div>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                            <li class="dropdown-user-info">
                                <div class="fw-semibold" id="user-name">John Doe</div>
                                <div class="small text-muted" id="user-email">john@example.com</div>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="profile.html"><i class="bi bi-person me-2"></i>Profile</a></li>
                            <li><a class="dropdown-item" href="settings.html"><i class="bi bi-gear me-2"></i>Settings</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" id="header-logout"><i class="bi bi-box-arrow-right me-2"></i>Logout</a></li>
                        </ul>
                    </div>
                </div>
            </header>

            <div class="content-body">
                <div class="page-title-wrapper d-flex justify-content-between align-items-center mb-4">
                    <h1 class="page-title">API Keys</h1>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createApiKeyModal">
                        <i class="bi bi-plus-lg me-1"></i> Create API Key
                    </button>
                </div>

                <!-- API Keys Info Card -->
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <i class="bi bi-info-circle text-primary me-2 fs-4"></i>
                            <h5 class="mb-0">API Keys Information</h5>
                        </div>
                        <p class="mb-0">API keys are used to authenticate your API requests. Keep your API keys secure and never share them publicly. Each key has specific permissions and can be restricted to certain IP addresses for enhanced security.</p>
                    </div>
                </div>

                <!-- API Keys Table -->
                <div class="card">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover table-striped mb-0">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Key Prefix</th>
                                        <th>Permissions</th>
                                        <th>Created Date</th>
                                        <th>Last Used</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="api-keys-table-body">
                                    <!-- Skeleton loading rows -->
                                    <tr class="skeleton-row">
                                        <td><div class="skeleton-text"></div></td>
                                        <td><div class="skeleton-text"></div></td>
                                        <td><div class="skeleton-text"></div></td>
                                        <td><div class="skeleton-text"></div></td>
                                        <td><div class="skeleton-text"></div></td>
                                        <td><div class="skeleton-badge"></div></td>
                                        <td><div class="skeleton-actions"></div></td>
                                    </tr>
                                    <tr class="skeleton-row">
                                        <td><div class="skeleton-text"></div></td>
                                        <td><div class="skeleton-text"></div></td>
                                        <td><div class="skeleton-text"></div></td>
                                        <td><div class="skeleton-text"></div></td>
                                        <td><div class="skeleton-text"></div></td>
                                        <td><div class="skeleton-badge"></div></td>
                                        <td><div class="skeleton-actions"></div></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Create API Key Modal -->
    <div class="modal fade" id="createApiKeyModal" tabindex="-1" aria-labelledby="createApiKeyModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="createApiKeyModalLabel">Create API Key</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="create-api-key-form">
                        <div class="mb-3">
                            <label for="api-key-name" class="form-label">API Key Name</label>
                            <input type="text" class="form-control" id="api-key-name" placeholder="e.g., Production API Key" required>
                            <div class="form-text">A descriptive name to identify this API key.</div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Permissions</label>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" value="read" id="permission-read" checked>
                                <label class="form-check-label" for="permission-read">Read (View data)</label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" value="write" id="permission-write" checked>
                                <label class="form-check-label" for="permission-write">Write (Create and update data)</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="admin" id="permission-admin">
                                <label class="form-check-label" for="permission-admin">Admin (Full access, including API key management)</label>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">IP Restrictions (Optional)</label>
                            <div class="input-group mb-2">
                                <input type="text" class="form-control" id="ip-restriction" placeholder="e.g., 192.168.1.1">
                                <button class="btn btn-outline-secondary" type="button" id="add-ip-btn">Add</button>
                            </div>
                            <div class="form-text mb-2">Restrict API key usage to specific IP addresses. Leave empty to allow all IPs.</div>
                            <div id="ip-restrictions-list" class="d-flex flex-wrap gap-2">
                                <!-- IP addresses will be added here -->
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="api-key-expiry" class="form-label">Expiry Date (Optional)</label>
                            <input type="date" class="form-control" id="api-key-expiry">
                            <div class="form-text">Set an expiration date for this API key. Leave empty for no expiration.</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="create-api-key-btn">Create API Key</button>
                </div>
            </div>
        </div>
    </div>

    <!-- API Key Created Modal -->
    <div class="modal fade" id="apiKeyCreatedModal" tabindex="-1" aria-labelledby="apiKeyCreatedModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="apiKeyCreatedModalLabel">API Key Created Successfully</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        <strong>Important:</strong> This is the only time your API key will be displayed. Please copy it now and store it securely.
                    </div>
                    
                    <div class="mb-4">
                        <label class="form-label">Your API Key</label>
                        <div class="input-group">
                            <input type="text" class="form-control font-monospace" id="new-api-key" readonly>
                            <button class="btn btn-outline-primary" type="button" id="copy-api-key-btn">
                                <i class="bi bi-clipboard"></i> Copy
                            </button>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <h6>API Key Details</h6>
                        <table class="table table-sm">
                            <tbody>
                                <tr>
                                    <th style="width: 150px;">Name</th>
                                    <td id="api-key-detail-name">Production API Key</td>
                                </tr>
                                <tr>
                                    <th>Permissions</th>
                                    <td id="api-key-detail-permissions">Read, Write</td>
                                </tr>
                                <tr>
                                    <th>IP Restrictions</th>
                                    <td id="api-key-detail-ips">None</td>
                                </tr>
                                <tr>
                                    <th>Expiry Date</th>
                                    <td id="api-key-detail-expiry">No expiration</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">I've Copied My API Key</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/payment-api.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Authentication check
            if (!localStorage.getItem('jwt_token')) {
                window.location.href = 'login.html';
                return;
            }
            
            // Initialize API keys page
            initializeApiKeysPage();
            
            // Mobile menu toggle
            const menuToggle = document.getElementById('menu-toggle');
            const sidebarToggle = document.getElementById('sidebar-toggle');
            const sidebar = document.getElementById('sidebar');
            
            menuToggle.addEventListener('click', function() {
                sidebar.classList.add('active');
            });
            
            sidebarToggle.addEventListener('click', function() {
                sidebar.classList.remove('active');
            });
            
            // Logout functionality
            document.getElementById('logout-link').addEventListener('click', handleLogout);
            document.getElementById('header-logout').addEventListener('click', handleLogout);
            
            function handleLogout(e) {
                e.preventDefault();
                localStorage.removeItem('jwt_token');
                localStorage.removeItem('user_data');
                window.location.href = 'login.html';
            }
            
            // Set user info
            const userData = JSON.parse(localStorage.getItem('user_data') || '{}');
            if (userData.firstName && userData.lastName) {
                document.getElementById('user-name').textContent = `${userData.firstName} ${userData.lastName}`;
                document.getElementById('user-initials').textContent = `${userData.firstName.charAt(0)}${userData.lastName.charAt(0)}`;
            }
            
            if (userData.email) {
                document.getElementById('user-email').textContent = userData.email;
            }

            // Add IP restriction
            document.getElementById('add-ip-btn').addEventListener('click', function() {
                const ipInput = document.getElementById('ip-restriction');
                const ipValue = ipInput.value.trim();
                
                if (ipValue) {
                    const ipList = document.getElementById('ip-restrictions-list');
                    
                    // Create IP badge
                    const ipBadge = document.createElement('div');
                    ipBadge.className = 'badge bg-light text-dark d-flex align-items-center p-2';
                    ipBadge.innerHTML = `
                        <span>${ipValue}</span>
                        <button type="button" class="btn-close btn-close-sm ms-2" aria-label="Remove"></button>
                    `;
                    
                    // Add remove functionality
                    ipBadge.querySelector('.btn-close').addEventListener('click', function() {
                        ipBadge.remove();
                    });
                    
                    ipList.appendChild(ipBadge);
                    ipInput.value = '';
                }
            });

            // Create API Key button
            document.getElementById('create-api-key-btn').addEventListener('click', function() {
                const apiKeyName = document.getElementById('api-key-name').value.trim();
                
                if (!apiKeyName) {
                    alert('Please enter a name for your API key');
                    return;
                }
                
                // Get permissions
                const permissions = [];
                if (document.getElementById('permission-read').checked) permissions.push('read');
                if (document.getElementById('permission-write').checked) permissions.push('write');
                if (document.getElementById('permission-admin').checked) permissions.push('admin');
                
                // Get IP restrictions
                const ipRestrictions = [];
                document.querySelectorAll('#ip-restrictions-list .badge span').forEach(span => {
                    ipRestrictions.push(span.textContent);
                });
                
                // Get expiry date
                const expiryDate = document.getElementById('api-key-expiry').value;
                
                // Generate a fake API key
                const apiKey = generateApiKey();
                
                // Show the API key created modal
                document.getElementById('new-api-key').value = apiKey;
                document.getElementById('api-key-detail-name').textContent = apiKeyName;
                document.getElementById('api-key-detail-permissions').textContent = permissions.join(', ');
                document.getElementById('api-key-detail-ips').textContent = ipRestrictions.length > 0 ? ipRestrictions.join(', ') : 'None';
                document.getElementById('api-key-detail-expiry').textContent = expiryDate ? new Date(expiryDate).toLocaleDateString() : 'No expiration';
                
                // Hide the create modal and show the created modal
                const createModal = bootstrap.Modal.getInstance(document.getElementById('createApiKeyModal'));
                createModal.hide();
                
                const createdModal = new bootstrap.Modal(document.getElementById('apiKeyCreatedModal'));
                createdModal.show();
                
                // Reset the form
                document.getElementById('create-api-key-form').reset();
                document.getElementById('ip-restrictions-list').innerHTML = '';
                
                // Refresh the API keys table
                initializeApiKeysPage();
            });

            // Copy API key button
            document.getElementById('copy-api-key-btn').addEventListener('click', function() {
                const apiKeyInput = document.getElementById('new-api-key');
                apiKeyInput.select();
                document.execCommand('copy');
                this.innerHTML = '<i class="bi bi-check-lg"></i> Copied!';
                setTimeout(() => {
                    this.innerHTML = '<i class="bi bi-clipboard"></i> Copy';
                }, 2000);
            });

            // Initialize API keys functionality
            function initializeApiKeysPage() {
                // This would be implemented to fetch and display API keys
                // For now, we'll just simulate loading with a timeout
                setTimeout(() => {
                    document.querySelectorAll('.skeleton-row').forEach(row => row.remove());
                    
                    // Sample data
                    const apiKeys = [
                        {
                            id: 'key_123456',
                            name: 'Production API Key',
                            prefix: 'pk_live_abc123',
                            permissions: ['read', 'write'],
                            createdDate: 'Jun 15, 2023',
                            lastUsed: '2 hours ago',
                            status: 'active'
                        },
                        {
                            id: 'key_789012',
                            name: 'Test API Key',
                            prefix: 'pk_test_def456',
                            permissions: ['read', 'write', 'admin'],
                            createdDate: 'Jun 10, 2023',
                            lastUsed: '1 day ago',
                            status: 'active'
                        },
                        {
                            id: 'key_345678',
                            name: 'Legacy API Key',
                            prefix: 'pk_live_ghi789',
                            permissions: ['read'],
                            createdDate: 'May 5, 2023',
                            lastUsed: '30 days ago',
                            status: 'revoked'
                        }
                    ];
                    
                    const tableBody = document.getElementById('api-keys-table-body');
                    
                    apiKeys.forEach(apiKey => {
                        const row = document.createElement('tr');
                        
                        // Name column
                        const nameCell = document.createElement('td');
                        nameCell.textContent = apiKey.name;
                        row.appendChild(nameCell);
                        
                        // Key Prefix column
                        const prefixCell = document.createElement('td');
                        prefixCell.className = 'font-monospace';
                        prefixCell.textContent = apiKey.prefix + '...';
                        row.appendChild(prefixCell);
                        
                        // Permissions column
                        const permissionsCell = document.createElement('td');
                        const permissionsList = document.createElement('div');
                        apiKey.permissions.forEach(permission => {
                            const badge = document.createElement('span');
                            badge.className = 'badge bg-light text-dark me-1';
                            badge.textContent = permission;
                            permissionsList.appendChild(badge);
                        });
                        permissionsCell.appendChild(permissionsList);
                        row.appendChild(permissionsCell);
                        
                        // Created Date column
                        const createdDateCell = document.createElement('td');
                        createdDateCell.textContent = apiKey.createdDate;
                        row.appendChild(createdDateCell);
                        
                        // Last Used column
                        const lastUsedCell = document.createElement('td');
                        lastUsedCell.textContent = apiKey.lastUsed;
                        row.appendChild(lastUsedCell);
                        
                        // Status column
                        const statusCell = document.createElement('td');
                        const statusBadge = document.createElement('span');
                        statusBadge.className = apiKey.status === 'active' ? 'badge bg-success' : 'badge bg-danger';
                        statusBadge.textContent = apiKey.status === 'active' ? 'Active' : 'Revoked';
                        statusCell.appendChild(statusBadge);
                        row.appendChild(statusCell);
                        
                        // Actions column
                        const actionsCell = document.createElement('td');
                        const actionsDiv = document.createElement('div');
                        actionsDiv.className = 'd-flex gap-2';
                        
                        if (apiKey.status === 'active') {
                            const revokeBtn = document.createElement('button');
                            revokeBtn.className = 'btn btn-sm btn-outline-danger';
                            revokeBtn.innerHTML = '<i class="bi bi-x-circle"></i>';
                            revokeBtn.setAttribute('data-api-key-id', apiKey.id);
                            revokeBtn.setAttribute('title', 'Revoke API Key');
                            actionsDiv.appendChild(revokeBtn);
                        }
                        
                        actionsCell.appendChild(actionsDiv);
                        row.appendChild(actionsCell);
                        
                        tableBody.appendChild(row);
                    });
                }, 1000);
            }

            // Helper function to generate a fake API key
            function generateApiKey() {
                const prefix = Math.random() < 0.5 ? 'pk_live_' : 'pk_test_';
                const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
                let result = prefix;
                for (let i = 0; i < 24; i++) {
                    result += characters.charAt(Math.floor(Math.random() * characters.length));
                }
                return result;
            }
        });
    </script>
</body>
</html>